#!/bin/bash

# Comprehensive Flutter App Testing Suite
# Runs 100+ scenarios to validate app functionality

echo "ğŸš€ Starting Comprehensive Flutter App Testing"
echo "=============================================="
echo "Project: FWB - Friends With Benefits App"
echo "Date: $(date)"
echo ""

# Check if we're in the right directory
if [ ! -f "pubspec.yaml" ]; then
    echo "âŒ Error: Not in Flutter project directory"
    exit 1
fi

# Check if Python is available
if ! command -v python3 &> /dev/null; then
    echo "âŒ Error: Python3 is required but not installed"
    exit 1
fi

# Check if Flutter is available
if ! command -v flutter &> /dev/null; then
    echo "âŒ Error: Flutter is required but not installed"
    exit 1
fi

echo "ğŸ“‹ Pre-flight checks..."
echo "âœ… Flutter project detected"
echo "âœ… Python3 available"
echo "âœ… Flutter CLI available"
echo ""

# Clean and prepare
echo "ğŸ§¹ Cleaning project..."
flutter clean > /dev/null 2>&1
flutter pub get > /dev/null 2>&1
echo "âœ… Project cleaned and dependencies updated"
echo ""

# Run basic validation first
echo "ğŸ” Running basic validation..."
echo "- Analyzing code quality..."
ANALYZE_RESULT=$(flutter analyze --no-fatal-infos 2>&1)
ERROR_COUNT=$(echo "$ANALYZE_RESULT" | grep -c "error â€¢" || echo "0")
echo "  Found $ERROR_COUNT critical errors"

if [ "$ERROR_COUNT" -gt 100 ]; then
    echo "âš ï¸ Warning: High error count detected. Proceeding with testing..."
else
    echo "âœ… Code quality acceptable for testing"
fi
echo ""

# Run the basic test suite
echo "ğŸ§ª Running Basic Test Suite (100 scenarios)..."
echo "Testing: Build, Analysis, Dependencies, Structure"
python3 test_automation.py
echo ""

# Run the advanced test suite
echo "ğŸ¯ Running Advanced Test Suite (100 scenarios)..."
echo "Testing: UI/UX, Performance, Accessibility, Code Quality"
python3 advanced_test_suite.py
echo ""

# Generate final summary
echo "ğŸ“Š Generating Final Summary..."
echo "================================"

# Check if reports were generated
BASIC_REPORT=""
ADVANCED_REPORT=""

if [ -f "test_report.md" ]; then
    BASIC_REPORT=$(tail -10 test_report.md)
    echo "âœ… Basic test report generated"
else
    echo "âš ï¸ Basic test report not found"
fi

if [ -f "advanced_test_report.md" ]; then
    ADVANCED_REPORT=$(tail -10 advanced_test_report.md)
    echo "âœ… Advanced test report generated"
else
    echo "âš ï¸ Advanced test report not found"
fi

# Create combined summary
cat > final_test_summary.md << EOF
# ğŸ¯ Final Testing Summary

**Generated**: $(date)  
**Project**: FWB - Friends With Benefits App  
**Total Test Scenarios**: 200+ (Basic + Advanced)

## Test Execution Summary

### Basic Test Suite
- **Focus**: Build validation, code analysis, dependencies
- **Scenarios**: 100
- **Report**: $([ -f "test_report.md" ] && echo "âœ… Generated" || echo "âŒ Missing")

### Advanced Test Suite
- **Focus**: UI/UX, performance, accessibility, code quality
- **Scenarios**: 100
- **Report**: $([ -f "advanced_test_report.md" ] && echo "âœ… Generated" || echo "âŒ Missing")

## Quick Health Check

### Code Quality
- **Flutter Analyze**: $ERROR_COUNT critical errors
- **Status**: $([ "$ERROR_COUNT" -lt 50 ] && echo "ğŸŸ¢ Good" || echo "ğŸŸ¡ Needs attention")

### Project Structure
- **Screens**: $(find lib/screens -name "*.dart" | wc -l | tr -d ' ') files
- **Widgets**: $(find lib/widgets -name "*.dart" | wc -l | tr -d ' ') files
- **Models**: $(find lib/models -name "*.dart" | wc -l | tr -d ' ') files

### Dependencies
- **Status**: $(flutter pub deps > /dev/null 2>&1 && echo "âœ… Resolved" || echo "âŒ Issues found")

## Recommendations

$([ "$ERROR_COUNT" -lt 50 ] && echo "ğŸ‰ **Excellent**: Your app is in great shape!" || echo "âš ï¸ **Action Needed**: Review error reports and address critical issues.")

See detailed reports:
- \`test_report.md\` - Basic validation results
- \`advanced_test_report.md\` - Comprehensive analysis

## Next Steps

1. Review detailed test reports
2. Address any critical issues found
3. Continue regular testing during development
4. Monitor performance and accessibility metrics

---
*Generated by Flutter App Testing Suite*
EOF

echo ""
echo "ğŸ“‹ Final Summary Generated: final_test_summary.md"
echo ""

# Display key metrics
echo "ğŸ¯ KEY METRICS"
echo "=============="
echo "Critical Errors: $ERROR_COUNT"
echo "Project Files: $(find lib -name "*.dart" | wc -l | tr -d ' ') Dart files"
echo "Test Reports: $(ls -1 *_report.md 2>/dev/null | wc -l | tr -d ' ') generated"
echo ""

# Final status
if [ "$ERROR_COUNT" -lt 50 ] && [ -f "test_report.md" ] && [ -f "advanced_test_report.md" ]; then
    echo "ğŸ‰ SUCCESS: Comprehensive testing completed successfully!"
    echo "ğŸ“Š All reports generated. Your app is ready for review."
    EXIT_CODE=0
else
    echo "âš ï¸ PARTIAL SUCCESS: Testing completed with some issues."
    echo "ğŸ“‹ Review the generated reports for details."
    EXIT_CODE=1
fi

echo ""
echo "Testing completed at $(date)"
echo "=============================================="

exit $EXIT_CODE
